// Generated by OABuilder
package com.remodel.model.oa;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.logging.Logger;

import com.viaoa.annotation.OACalculatedProperty;
import com.viaoa.annotation.OAClass;
import com.viaoa.annotation.OAColumn;
import com.viaoa.annotation.OAFkey;
import com.viaoa.annotation.OAId;
import com.viaoa.annotation.OAIndex;
import com.viaoa.annotation.OAIndexColumn;
import com.viaoa.annotation.OAMany;
import com.viaoa.annotation.OAMethod;
import com.viaoa.annotation.OAObjCallback;
import com.viaoa.annotation.OAOne;
import com.viaoa.annotation.OAProperty;
import com.viaoa.annotation.OATable;
import com.viaoa.hub.Hub;
import com.viaoa.object.OAObject;
import com.viaoa.object.OAObjectCallback;
import com.viaoa.object.OAObjectInfoDelegate;
import com.viaoa.object.OAObjectKey;
import com.viaoa.util.OADateTime;
import com.viaoa.util.OAString;

@OAClass(lowerName = "repository", pluralName = "Repositories", shortName = "rps", displayName = "Repository", displayProperty = "fileName", rootTreePropertyPaths = {
		"[Project]." + Project.P_Repositories
})
@OATable(indexes = {
		@OAIndex(name = "RepositoryMainTable", fkey = true, columns = { @OAIndexColumn(name = "MainTableId") }),
		@OAIndex(name = "RepositoryProject", fkey = true, columns = { @OAIndexColumn(name = "ProjectId") })
})
public class Repository extends OAObject {
	private static final long serialVersionUID = 1L;
	private static Logger LOG = Logger.getLogger(Repository.class.getName());

	public static final String P_Id = "Id";
	public static final String P_Created = "Created";
	public static final String P_FileName = "FileName";
	public static final String P_PackageName = "PackageName";
	public static final String P_Seq = "Seq";
	public static final String P_Description = "Description";

	public static final String P_FileExists = "FileExists";

	public static final String P_MainTable = "MainTable";
	public static final String P_Project = "Project";
	public static final String P_QueryInfos = "QueryInfos";

	public static final String M_Parse = "Parse";
	protected volatile int id;
	protected volatile OADateTime created;
	protected volatile String fileName;
	protected volatile String packageName;
	protected volatile int seq;
	protected volatile String description;

	// Links to other objects.
	protected volatile transient Table mainTable;
	protected volatile transient Project project;
	protected transient Hub<QueryInfo> hubQueryInfos;

	public Repository() {
		if (!isLoading()) {
			setObjectDefaults();
		}
	}

	@Override
	public void setObjectDefaults() {
		setCreated(new OADateTime());
	}

	public Repository(int id) {
		this();
		setId(id);
	}

	@OAProperty(isUnique = true, trackPrimitiveNull = false, displayLength = 6)
	@OAId()
	@OAColumn(sqlType = java.sql.Types.INTEGER)
	public int getId() {
		return id;
	}

	public void setId(int newValue) {
		int old = id;
		fireBeforePropertyChange(P_Id, old, newValue);
		this.id = newValue;
		firePropertyChange(P_Id, old, this.id);
	}

	@OAProperty(defaultValue = "new OADateTime()", displayLength = 15, isProcessed = true)
	@OAColumn(sqlType = java.sql.Types.TIMESTAMP)
	public OADateTime getCreated() {
		return created;
	}

	public void setCreated(OADateTime newValue) {
		OADateTime old = created;
		fireBeforePropertyChange(P_Created, old, newValue);
		this.created = newValue;
		firePropertyChange(P_Created, old, this.created);
	}

	@OAProperty(displayName = "File Name", maxLength = 250, displayLength = 20, hasCustomCode = true, isFileName = true)
	@OAColumn(maxLength = 250)
	public String getFileName() {
		return fileName;
	}

	public void setFileName(String newValue) {
		String[] ss = null;
		if (!isLoading()) {
			ss = convertFileName(newValue);
			newValue = ss[0];
		}

		String old = fileName;
		fireBeforePropertyChange(P_FileName, old, newValue);
		this.fileName = newValue;
		firePropertyChange(P_FileName, old, this.fileName);

		if (ss != null) {
			setPackageName(ss[1]);
		}
	}

	protected String[] convertFileName(String fn) {
		String[] ss = new String[2];

		ss[0] = fn;
		ss[1] = getPackageName();

		if (OAString.isEmpty(fn)) {
			return ss;
		}
		Project proj = getProject();
		if (proj == null) {
			return ss;
		}
		String s = proj.getCodeDirectory();
		if (OAString.isNotEmpty(s) && fn.startsWith(s)) {
			fn = fn.substring(s.length() + 1);
		}

		fn = OAString.convert(fn, "\\", "/");

		int dcnt = OAString.dcount(fn, "/");
		if (dcnt > 1) {
			s = OAString.field(fn, "/", 1, dcnt - 1);
			s = OAString.convert(s, "/", ".");
			ss[1] = s;

			fn = OAString.field(fn, "/", dcnt);
		}
		ss[0] = fn;
		return ss;
	}

	@OAProperty(displayName = "Package Name", maxLength = 150, displayLength = 20)
	@OAColumn(maxLength = 150)
	public String getPackageName() {
		return packageName;
	}

	public void setPackageName(String newValue) {
		String old = packageName;
		fireBeforePropertyChange(P_PackageName, old, newValue);
		this.packageName = newValue;
		firePropertyChange(P_PackageName, old, this.packageName);
	}

	@OAProperty(displayLength = 6, isAutoSeq = true)
	@OAColumn(sqlType = java.sql.Types.INTEGER)
	public int getSeq() {
		return seq;
	}

	public void setSeq(int newValue) {
		int old = seq;
		fireBeforePropertyChange(P_Seq, old, newValue);
		this.seq = newValue;
		firePropertyChange(P_Seq, old, this.seq);
	}

	@OAProperty(displayLength = 30, columnLength = 20)
	@OAColumn(sqlType = java.sql.Types.CLOB)
	public String getDescription() {
		return description;
	}

	public void setDescription(String newValue) {
		String old = description;
		fireBeforePropertyChange(P_Description, old, newValue);
		this.description = newValue;
		firePropertyChange(P_Description, old, this.description);
	}

	@OACalculatedProperty(displayName = "File Exists", displayLength = 5, columnLength = 6, columnName = "Exists", properties = {
			P_FileName, P_PackageName, P_Project + "." + Project.P_CodeDirectory })
	public boolean getFileExists() {
		//boolean b = RepositoryDelegate.getFileExists(this);
		//return b;
		return false;
	}

	public boolean isFileExists() {
		return getFileExists();
	}

	@OAOne(displayName = "Main Table", reverseName = Table.P_Repositories, allowCreateNew = false)
	@OAFkey(columns = { "MainTableId" })
	public Table getMainTable() {
		if (mainTable == null) {
			mainTable = (Table) getObject(P_MainTable);
		}
		return mainTable;
	}

	public void setMainTable(Table newValue) {
		Table old = this.mainTable;
		fireBeforePropertyChange(P_MainTable, old, newValue);
		this.mainTable = newValue;
		firePropertyChange(P_MainTable, old, this.mainTable);
	}

	@OAOne(reverseName = Project.P_Repositories, required = true, allowCreateNew = false)
	@OAFkey(columns = { "ProjectId" })
	public Project getProject() {
		if (project == null) {
			project = (Project) getObject(P_Project);
		}
		return project;
	}

	public void setProject(Project newValue) {
		Project old = this.project;
		fireBeforePropertyChange(P_Project, old, newValue);
		this.project = newValue;
		firePropertyChange(P_Project, old, this.project);
	}

	@OAMany(displayName = "Query Infos", toClass = QueryInfo.class, owner = true, reverseName = QueryInfo.P_Repository, cascadeSave = true, cascadeDelete = true, seqProperty = QueryInfo.P_Seq, sortProperty = QueryInfo.P_Seq)
	public Hub<QueryInfo> getQueryInfos() {
		if (hubQueryInfos == null) {
			hubQueryInfos = (Hub<QueryInfo>) getHub(P_QueryInfos);
		}
		return hubQueryInfos;
	}

	@OAMethod(displayName = "Parse")
	public void parse() {
		try {
			// RepositoryDelegate.parse(this);
		} catch (Exception e) {
			throw new RuntimeException("failed to parse", e);
		}
	}

	@OAObjCallback
	public void parseCallback(final OAObjectCallback callback) {
		switch (callback.getType()) {
		case SetConfirmForCommand:
			if (getQueryInfos().getSize() > 0) {
				callback.setConfirmMessage("OK to reparse for SQL Query information");
				callback.setConfirmTitle("confirm");
			}
			break;
		}
	}

	public void load(ResultSet rs, int id) throws SQLException {
		this.id = id;
		java.sql.Timestamp timestamp;
		timestamp = rs.getTimestamp(2);
		if (timestamp != null) {
			this.created = new OADateTime(timestamp);
		}
		this.fileName = rs.getString(3);
		this.packageName = rs.getString(4);
		this.seq = (int) rs.getInt(5);
		if (rs.wasNull()) {
			OAObjectInfoDelegate.setPrimitiveNull(this, Repository.P_Seq, true);
		}
		this.description = rs.getString(6);
		int mainTableFkey = rs.getInt(7);
		if (!rs.wasNull() && mainTableFkey > 0) {
			setProperty(P_MainTable, new OAObjectKey(mainTableFkey));
		}
		int projectFkey = rs.getInt(8);
		if (!rs.wasNull() && projectFkey > 0) {
			setProperty(P_Project, new OAObjectKey(projectFkey));
		}
		if (rs.getMetaData().getColumnCount() != 8) {
			throw new SQLException("invalid number of columns for load method");
		}

		this.changedFlag = false;
		this.newFlag = false;
	}
}
